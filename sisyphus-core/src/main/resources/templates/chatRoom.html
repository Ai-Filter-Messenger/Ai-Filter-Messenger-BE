<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            background-color: #222;
            color: #ccc;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-height: 100%;
        }

        .chat-list {
            width: 30%;
            background-color: #2a2a2a;
            padding: 10px;
            overflow-y: scroll;
        }

        .chat-list .list-group-item {
            background-color: #333;
            color: #ccc;
            border: none;
            margin-bottom: 5px;
            padding: 10px;
            cursor: pointer;
        }

        .chat-list .list-group-item.active {
            background-color: #444;
        }

        .chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: #1a1a1a;
            padding: 20px;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: scroll;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
        }

        .chat-messages .message {
            margin-bottom: 10px;
        }

        .chat-messages .message .sender {
            font-weight: bold;
            margin-right: 5px;
        }

        .chat-messages .message.other {
            text-align: left;
            background-color: #333;
            color: #ccc;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 60%;
            clear: both;
            float: left;
        }

        /* Apply this to your own messages */
        .chat-messages .message.mine {
            text-align: right;
            background-color: #5a67d8;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 60%;
            clear: both;
            float: right;
        }

        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #2a2a2a;
        }

        .chat-footer input {
            flex-grow: 1;
            background-color: #333;
            color: #ccc;
            border: none;
            padding: 10px;
            margin-right: 10px;
        }

        .chat-footer button {
            background-color: #5a67d8;
            color: white;
            border: none;
            padding: 10px 20px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2a2a2a;
            padding: 10px;
        }

        .chat-header h5 {
            margin: 0;
            color: #ccc;
        }

        .btn-danger {
            background-color: #e53e3e;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <!-- Left side: Chat Room List -->
    <div class="chat-list">
        <div class="list-group" id="chatRoomList">
            <!-- Chat room list rendered here -->
        </div>
    </div>

    <!-- Right side: Chat Room -->
    <div class="chat-window">
        <div class="chat-header">
            <h5 th:text="${room.roomName}">Chat Room</h5>
            <button class="btn btn-danger btn-sm" id="leaveBtn">Leave</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be appended here -->
        </div>
        <div class="chat-footer">
            <input type="text" id="messageInput" placeholder="Type a message">
            <button type="button" id="sendBtn">Send</button>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    const roomId = [[${room.chatRoomId}]]; // 방 ID
    const senderName = '[[${user.name}]]'; // 유저 이름
    const senderId = '[[${user.id}]]'; // 유저 ID

    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 채팅 메시지 구독
            stompClient.subscribe('/topic/chatroom/' + roomId, function (message) {
                showMessage(JSON.parse(message.body));
            });

            // 방에 입장
            stompClient.send('/app/chat/join', {}, JSON.stringify({
                roomId: roomId,
                senderName: senderName,
                senderId: senderId,
                message: senderName
            }));
        });
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        if (message && stompClient) {
            stompClient.send('/app/chat/send', {}, JSON.stringify({
                roomId: roomId,
                message: message,
                senderName: senderName,
                senderId: senderId
            }));
            messageInput.value = '';
        }
    }

    function showMessage(message) {
        const messageContainer = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        if (message.senderName === senderName) {
            messageElement.classList.add('mine');
        } else {
            messageElement.classList.add('other');
        }

        messageElement.innerHTML = `<span class="sender">${message.senderName}:</span> ${message.message}`;
        messageContainer.appendChild(messageElement);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    function leaveRoom() {
        if (stompClient) {
            // WebSocket으로 퇴장 메시지 보내기
            stompClient.send('/app/chat/leave', {}, JSON.stringify({
                roomId: roomId,
                senderName: senderName,
                senderId: senderId,
                message: senderName
            }));
        }

        // REST API 호출하여 서버에서 퇴장 처리
        fetch('/api/chat/leave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chatRoomId: roomId,
                loginId: senderName
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data); // "방에서 퇴장하셨습니다." 메시지를 받을 수 있음
            })
            .catch(error => {
                console.error('Error during leave room:', error);
            });
        window.location.href = "/chat/list"; // 나가기 후 목록 페이지로 이동
    }

    document.getElementById('sendBtn').addEventListener('click', function () {
        sendMessage();
    });

    document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    document.getElementById('leaveBtn').addEventListener('click', function () {
        leaveRoom();
    });

    connect();

    function loadChatRoomList() {
        fetch(`/api/chat/find/list?loginId=${senderName}`)
            .then(response => response.json())
            .then(rooms => {
                if (!Array.isArray(rooms) || rooms.length === 0) {
                    console.warn("No chat rooms available.");
                    return;
                }

                const chatRoomList = document.getElementById('chatRoomList');
                chatRoomList.innerHTML = ''; // 기존 리스트 초기화

                rooms.forEach(room => {
                    // Create a container div for each room
                    const roomElement = document.createElement('a');
                    roomElement.href = `/chat/${room.chatRoomId}/${senderName}`;
                    roomElement.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'align-items-center', 'position-relative');
                    roomElement.style.backgroundColor = '#333';
                    roomElement.style.color = '#ccc';
                    roomElement.style.border = 'none';
                    roomElement.style.marginBottom = '10px'; // 아래 간격 추가
                    roomElement.style.padding = '15px'; // 패딩 조절

                    // Profile image container
                    const profileImgContainer = document.createElement('div');
                    profileImgContainer.style.display = 'flex';
                    profileImgContainer.style.alignItems = 'center';
                    profileImgContainer.style.justifyContent = 'start';
                    profileImgContainer.style.width = '80px'; // 이미지 영역 고정
                    profileImgContainer.style.position = 'relative';

                    // 프로필 이미지 처리 (최대 3개까지만 표시)
                    const profileImagesToShow = room.profileImages.slice(0, 3);
                    profileImagesToShow.forEach((url, index) => {
                        const profileImg = document.createElement('img');
                        profileImg.src = url; // 배열로 넘어온 profileImages 사용
                        profileImg.alt = 'Profile Image';
                        profileImg.style.width = '25px';
                        profileImg.style.height = '25px';
                        profileImg.style.borderRadius = '50%';
                        profileImg.style.position = 'absolute';
                        profileImg.style.left = `${index * 10}px`; // 이미지 겹침 효과
                        profileImg.style.zIndex = `${10 - index}`; // z-index 설정

                        profileImgContainer.appendChild(profileImg);
                    });

                    // Create room info div
                    const roomInfoDiv = document.createElement('div');

                    const roomNameDiv = document.createElement('div');
                    roomNameDiv.textContent = room.roomName ? room.roomName : 'Unnamed Room'; // 방 이름이 없을 경우 처리
                    roomNameDiv.style.fontWeight = 'bold';
                    roomNameDiv.style.color = '#fff';

                    // Create room type div
                    const roomTypeDiv = document.createElement('div');
                    roomTypeDiv.textContent = room.type === 'OPEN' ? '오픈채팅' : '일반채팅'; // 방 타입 처리
                    roomTypeDiv.style.fontSize = '12px';
                    roomTypeDiv.style.color = '#aaa';
                    roomTypeDiv.style.marginTop = '5px'; // 방 타입과 방 이름 사이 간격 추가

                    // Append room name and type to room info div
                    roomInfoDiv.appendChild(roomNameDiv);
                    roomInfoDiv.appendChild(roomTypeDiv);

                    // Append profile image container and room info to room element
                    roomElement.appendChild(profileImgContainer);
                    roomElement.appendChild(roomInfoDiv);

                    // Append the room element to the chat room list
                    chatRoomList.appendChild(roomElement);
                });
            })
            .catch(error => console.error('Error fetching chat rooms:', error));
    }

    loadChatRoomList();
</script>

</body>
</html>